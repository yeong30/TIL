# CPU

CPU는 메모리에 저장된 명령어를 읽고 해석하고 실행하는 장치이다. CPU 내부에는 **계산을 담당하는 ALU**, **명령어를 해석하고 제어신호를 내보내느 제어장치**, **작은 임시 저장 장치 레지스터**가 있다.

# ALU

ALU는 산술논리연산장치로 **CPU 내에서 계산을 수행**한다. ALU는 레지스터로부터 피연산자, 제어신호로 수행할 연산을 받아 연산을 수행하고 그 결과를 다시 레지스터로 내보낸다. 또한 플래그를 플래그 레지스터로 내보낸다.

#### 플래그

ALU가 내보내는 **플래그는 연산에 관한 부가정보**이다. ALU가 내보내는 대표적인 플래그는 아래와 같다.

- 부호 플래그 : 연산 결과의 부호
- 제로 플래그 : 연산 결과가 0인지 여부
- 캐리 플래그 : 연산 결과 올림수가 빌림수가 발생했는지
- 오버 플로우 플래그 : 오버플로우가 발생했는지
- 인터럽트 플래그 : 인터럽트가 가능한지
- 슈퍼바이저 플래그 : 커널모드인지 사용자 모드인지

### 제어장치

제어장치는 CPU내에서 **제어신호를 내보내고 명령어를 해석하는 장치**이다. 제어장치는 명령어 레지스터에서 명령어를, 플래그 레지스터로부터 플래그를 읽어들이고 클럭신호를 전달받는다. 또한 명령어를 해석하여 다시 제어 신호를 내보낸다. 제어장치는 제어신호를 내보내지만 입출력장치등으로부터 제어신호를 받기도 한다.

### 레지스터

레지스터는 CPU내에 임시 저장장치이다. 레지스터의 종류는 다양하다.

1. 프로그램 카운터 : 다음으로 실행할 명령어 주소를 저장한다.
2. 명령어 레지스터 : 다음으로 실행할 명령어를 저장한다. 방금 메모리에서 읽어들인 명령어이다. 해당 명령어는 제어장치로 전달되어 해석된다.
3. 메모리 주소 레지스터 : 메모리의 주소를 저장하는 레지스터이다. 읽어들이고자 하는 주소값을 버스로 보낼 때 메모리 주소 레지스터를 거치게 된다.
4. 메모리 버퍼 레지스터 : 메모리와 주고받을 데이터를 저장하는 레지스터이다. 메모리에 저장하거나 전달받은 값으로서 데이터 주소로 주고받은 값은 메모리 버퍼 레지스터를 거친다.
5. 플래그 레지스터 : 연산결과에 따른 플래그를 위한 레지스터이다.
6. 범용 레지스터 : 범용적으로 사용할 수 있는 레지스터로 여러개의 범용 레지스터가 있다
7. 스택 포인터 : 특별한 주소지정에 사용되는 레지스터로 스택의 포인터 정보 , 즉 스택의 꼭대기를 가리키는 레지스터다. 현재 스택이 얼마나 차있는지를 저장한다.(스택은 메모리안에)
8. 베이스 레지스터 : 스택포인터와 마찬가지로 특별한 주소지정에 사용되는 레지스터로, 오퍼랜드 필드값(변위)과 더하여 유효주소를 구할 때 사용된다. 해당 방식은 베이스 레지스터 주소 지정방식이다.

- 프로그램카운터와 오퍼랜드 필드값(변위)을 더하여 유효주소를 구할 수도 있다. 해당 방식은 상대 주소 지정 방식이다.

## CPU 성능 향상 기법

CPU를 설계할 때 중요한 것은 빠른 CPU를 만드는 일이다. 그렇다면 어떻게 설계해야할까?

### 1. 클럭속도 증가

CPU를 비롯한 컴퓨터 부품들은 클럭신호에 맞추어 움직이며 클럭속도가 높아지면 그만큼 더 빠르게 명령어 사이클을 반복할 것이다. 따라서 클럭 속도가 높은 CPU가 일반적으로는 성능이 좋다. 클럭속도는 CPU 속도 단위로 간주되기도 한다.

#### 클럭속도

클럭속도는 헤르츠(Hz) 단위로 측정된다. 헤르츠는 1초에 클럭이 몇번 반복되는지를 의미한다. 1초에 클럭이 한번 반복된다면 1Hz, 1초에 클럭이 100번 반복된다면 100Hz이다.

그렇다면 클럭속도를 계속 높인다면 무조건 CPU가 빨라질까?
그렇지는 않다. 클럭속도가 높아지면 CPU는 빨라지지만 발열 문제가 심각해진다.

### 2. 멀티코어와 멀티스레드

클럭 속도를 높이는 방법 외에 CPU의 코어의 수와 스레드의 수를 늘리는 방법이 있다.

#### 코어

과거 CPU는 명령어를 해석,실행하는 부품이 1개만 존재하며 CPU가 곧 해석,실행하는 부품이었다. 그런데 현대 CPU는 내부의 여러개의 해석,실행하는 부품이 존재한다. 오늘날 **명령어를 해석,실행하는 부품은 코어** 라는 용어라고 불리며 CPU는 해석,실행하는 부품을 포함하는 부품으로 명칭의 범위가 확장되었다. 즉 8코어 CPU는 해석,실행하는 부품이 8개 있는 CPU를 의미한다.
또한 이렇게 **코어를 여러개 포함하고 있는 CPU를 멀티코어 CPU, 멀티코어 프로세서** 라고 부른다.

당연히 코어가 여러개인 멀티코어가 싱글코어보다 빠르나 CPU 연산속도가 코어의 숫자에 비례하여 증가하지는 않는다. 중요한 것은 각각의 코어가 명령어를 얼마나 효율적으로 배분하고 적절하게 처리하느냐이다.

#### 스레드

스레드의 사전적 의미는 **실행흐름단위**이다. 그러나 CPU에서 사용되는 스레드와 프로그램에서 사용되는 스레드는 용례가 다르기때문에 구분이 필요하다. 스레드의 정의를 나누자면 하드웨어적 스레드와 소프트웨어적 스레드로 구분할 수 있다.

##### 하드웨어적 스레드

하드웨어적 스레드는 CPU에서 사용하는 스레드로서 **하나의 코어가 동시에 처리가능한 명렁어 단위**를 의미한다 즉 한번에 몇개의 명령어를 실행할 수 있느냐를 의미한다. 하나의 코어로 여러 명령어를 동시에 처리하는 CPU를 **멀티스레드 프로세서, 멀티스레드 CPU**라고 부른다.

#### 멀티스레드 프로세서

멀티스레드 프로세서가 가능한 이유는 여러개의 레지스터 세트가 있기 때문이다. 만약 하나의 코어안에 두개의 프로그램카운터가 있다면 메모리에서 가져올 명령어 주소를 지정할 수 있다. 만약 스택 카운터가 두개 있다면 두개의 스택을 관리할 수 있다. 이렇게 하나의 명령어를 실행하기 위해 꼭 필요한 레지스터의 세트가 2개 이상이라면 동시에 2개 이상의 명령어를 처리할 수 있다.

이렇게 멀티스레드여서 동시에 여러개의 명령어를 처리했을 때 사실 프로그램 입장에서는 CPU가 여러개 있는것 처럼 보인다. 따라서 하드웨어 스레드를 **논리 프로세서**라고 부르기도 한다. 즉 1개의 코어가 있고 해당 코어가 4개의 스레드를, 4개의 명령어를 동시 처리할 수 있다면 4개의 논리 프로세서를 가졌다고 할 수 있다.

##### 소프트웨어적 스레드

소프트웨어적 스레드는 **하나의 프로그램에서 실행되는 독립적인 실행 단위**를 의마한다. 즉 프로그램에서 한번에 몇개의 실행흐름이 실행될 수 있느냐를 의마한다.

### 명령어 병렬 처리 기법

위에 설명된 높은 클럭속도, 멀티코어, 멀티스레드처럼 물리적으로 빠르게 만드는것도 중요하지만 CPU가 놀지않고 효율적으로 동작하도록 만드는것도 중요하다.
이렇게 **CPU를 쉬지 않고 작동시키는 기법을 명렁어 병렬처리 기법**이라고 한다. 대표적인 명령어 병렬 처리기법으로 **명령어 파이프 라이닝**, **슈퍼스칼라**, **비순차적 명령어 처리**가 있다.

#### 1.명령어 파이프 라이닝

명령어 처리 과정은 세부적으로 보았을 때 명령어 인출, 명령어 해석, 명령어 실행, 결과 저장의 단계로 나눌 수 있다.
중요한 것은 여러개의 명렁어 처리과정에서 같은 과정이 겹치지만 않으면 CPU는 각 단계를 동시에 실행할 수 있다는 것이다. 예를 들어 한 명령어를 인출하는 동안 다른 명령어를 실행할 수 있고 연산 결과를 저장할 수 있다. 이렇게 공장 생산 라인과 같이 명령어 파이프라인에 넣고 동시에 처리하는 기법을 **명령어 파이프라이닝** 이라고 한다.

##### 파이프라인 위험

파이프라이닝은 효과적이지만 늘 잘 작동하는것은 아니다. **파이프라이닝은 특정 상황에서 성능향상에 실패하는데 이를 파이프라인 위험**이라고 부르며 **파이프라인 위험은 데이터 위험, 제어 위험, 구조적 위험** 으로 나뉜다.

- 데이터 위험 : 데이터 위험은 데이터 의존성에 의해 발생하며 어떤 명령어가 이전명령어를 끝까지 실행해야만 비로소 실행할 수 있는 경우이다.
- 제어 위험 : 프로그램 카운터의 갑작스러운 변화에 의해 발생하며 현재 실행중인 명령어로 인해 갑작스럽게 실행흐름이 바뀌는 경우이다. 이 경우 명령어 파이프라인에 미리 처리중이던 명령어들은 무쓸모가 된다.
- 구조적 위험 : 명령어들을 겹쳐 실행하는 과정에서 서로 다른 명령어가 동시에 APU,레지스터등과 같은 CPU 부품을 사용하려고 할 때 발생한다.

#### 2. 슈퍼스칼라

슈퍼스칼라는 **여러개의 파이프라인을 이용하는 구조**를 말하며 슈퍼스칼라 구조로 명령어 처리가 가능한 CPU를 슈퍼스칼라 프로세서, 슈퍼스칼라 CPU라고 한다.
멀티스레드 프로세서와 같이 동시에 여러개의 명령어를 처리 가능한 경우 슈퍼스칼라 구조를 사용할 수 있다.
슈퍼스칼라는 이론적으로는 파이프라인 개수에 비례하여 프로그램 처리속도가 빨라지지만 파이프라인 위험등으로 인해 실제로 파이프라인 개수에 비례하여 빨라지지는 않는다.

#### 3. 비순차적 명령어 처리

파이프라이닝, 슈퍼스칼라 기법을 포함해 모두 일반적인 명령어 처리는 순차적으로 진행되는데, **비 순차적 명령어 처리 기법은 명령어들을 순차적으로 실행하지 않고 순서를 바꿔 실행하여도 무방한 명령어를 먼저 실행하는 기법**이다.
만약 이전 명령어에 의존적인 명령어가 있다면 해당 명령어가 실행될 때까지 기다린다면 파이프라인이 멈춰버리게 된다. 대신 실행가능한, 비의존적인 명령어를 먼저 실행하여 파이프라인이 멈추는 것이 더 효율적일 것이다.
